# Confluence Synthetic Refresh

## Introduction
The Dev instances of Confluence and Jira both contain legacy data. The aim of this project is to create a pipeline which will create a clean instance and populate with synthetic data. The main pipeline for this project is found on [Gitlab](). This particular repo builds a Docker image which is then stored in ECR. The image contains the following scripts: 
1. Automate the initial setup wizard 
2. Install Plugins
3. Populate confluence with synthetic data 

## How to Use
1. Clone Repo
2. Checkout to development branch.
3. Make changes where required.
4. Ensure requirement.txt file is updated with any new requirements.
5. Commit changes and push to development.
6. Merge changes to main. This should trigger the pipeline

## Script Walkthrough
### 1. Setup Wizard
When a blank instance of Confluence is created, it requires a setup wizard to be completed. This script automates this process via a package called mechanize. The steps are as follows:
1. Set variables - These are sourced from the main pipeline in Gitlab. 
2. Set up a mechanize browser - This will be used to fill out the form in the subsequent steps.
3. Choose the setup mode - This is the first page of the form and will be a Production Installation. 
```
# Choose setup mode = Production Installation
br.select_form(nr=0)
br.form.find_control('setupType').readonly = False
br.form['setupType'] = 'custom'
res = br.submit()
print("Submitted install type OK")
```
4. License Key - Submit the license key. If this has changed, since this pipeline was built (2021), this will need amending. The new license key can be found in the settings of Jira. Admin access is required. 
```python
# Fill in the license key
br.select_form(nr=0)
br.form['confLicenseString']=confluence_key
br.submit()
print("Submitted license OK")
```
5. Select DB - We will use our own DB, so this option is selected
```python
# Select Own DB 
br.select_form(nr=0)
br.submit()
print("Chose DB OK")
```
6. Populate Database form.
```python
# Fill in the PSQL data
br.select_form(nr=0)
br.form['dbConfigInfo.hostname'] = psql_host
br.form['dbConfigInfo.port'] = '5432'
br.form['dbConfigInfo.databaseName'] = psql_db
br.form['dbConfigInfo.userName'] = psql_user
br.form['dbConfigInfo.password'] = psql_pass
br.submit()
print("Submitted PostgreSQL host OK")
```
7. Check status of pods - Upon submitting the database details, the pods tend to go down therefore the next step is important to ensure the pods are back up before resuming the script. 
```python
# Checking status of website - pods can go down 
stat=str(requests.get(url).status_code)
time.sleep(60)
print("Waiting for pods")
if re.search('50.',stat):
    time.sleep(60)
    print("Still waiting for pods")
else:
    print("Confluence up")
```
8. Select the type of site as an empty site
9. User Management - Select the option for internal user management
10. Create an Admin User  
     
 
### 2. Install Plugins
This is a bash script which installs 4 core Confluence Plugins. (N.B This is an added step which was not necessary for Jira) 
      
### 3. Synthetic Data 
This is a python script which generates spaces, pages, and adds comments via the Atlassian python package. The steps are as follows:
1. Establish Connection - The username and password are stored as Drone secrets in the main pipeline
```
def connection():
    global confluence
    confluence = Confluence(
        url='https://confluence.shs-dev.dsa-notprod.homeoffice.gov.uk',
        username=os.environ['USERNAME'],
        password=os.environ['PASSWORD'])
```
2. Generate random material - This uses a python module called essential_generators.
3. Get keys for all spaces - By default, when a blank instance is created, a single space is also created. This step is required to get the key for this default space. 
```python
def space_keys():
    global space_ids
    space_ids=[]
    all_spaces=confluence.get_all_spaces(start=0, limit=50)
    for key,value in all_spaces.items():
        if key=='results':
            for i in value:
                for a,b in i.items():
                    if a=="key":
                        space_ids.append(b)
    return space_ids
```
4. Create Spaces - An access token is required to create spaces. This can be created by navigating to Confluence Settings. Space names are randomly generated, and the key is generated by taking the first 5 letters and capitalising. Just a note of interest, typically space keys are 3 characters long but when debugging this script, a common error pertained to non-unique key names. As the names are randomly generated, it is possible the first 3 letters of two space names may coincide. Space names must be unique therefore taking 5 letters reduced this possibility.  
5. Create pages and add comments - The get space keys function is re-run to take into account any new spaces created in step 4. This list is then iterated through, and each space is populated with a specified number of pages and comments. Notably, the user can provide input by defining the number of pages and comments in the main pipeline. 
6. Run Functions 

## Credits
Aminah Ahmed | Ben Gilbert | Christopher Rogers 
